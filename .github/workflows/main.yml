# .github/workflows/run_load_test.yml

name: Manual Load Test Runner

# This allows you to trigger the workflow manually from the Actions tab
on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Name of the Python script to run'
        required: true
        default: 'script.py' # Assuming your script is named load_test.py
      max_workers:
        description: 'Max concurrent threads (workers)'
        required: true
        default: '300' # A safer default for shared runners

jobs:
  run-stress-test:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Check out repository
        uses: actions/checkout@v4

      # Step 2: Set up a specific version of Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Install the Python dependencies from requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Step 4: Run the Python script
      # It uses the input from the 'workflow_dispatch' event
      - name: Execute the load test
        run: |
          echo "Starting load test on script: ${{ github.event.inputs.script_name }}"
          echo "Using max workers: ${{ github.event.inputs.max_workers }}"
          # We need to modify the script on the fly to use the input value
          # sed is used to find and replace the `max_workers` value in the script
          sed -i 's/max_workers = 599/max_workers = ${{ github.event.inputs.max_workers }}/g' ${{ github.event.inputs.script_name }}
          python ${{ github.event.inputs.script_name }}
